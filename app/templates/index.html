<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android UI 自动化测试平台</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 自定义Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',    // 主色调（蓝色）
                        success: '#00B42A',    // 成功色（绿色）
                        warning: '#FF7D00',    // 警告色（橙色）
                        danger: '#F53F3F',     // 危险色（红色）
                        dark: '#1D2129',       // 深色文本
                        light: '#86909C'       // 浅色文本
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-android text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">Android UI 自动化测试平台</h1>
            </div>
            <div class="flex items hidden flex items-center space-x-4">
                <span id="current-time" class="text-light text-sm"></span>
                <button id="refresh-btn" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full-full transition-colors">
                    <i class="fa fa-refresh text-light"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 状态概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <i class="fa fa-mobile text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">在线设备数</h3>
                    <p id="online-device-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center text-success">
                    <i class="fa fa-list-alt text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">可用测试用例</h3>
                    <p id="test-suite-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                    <i class="fa fa-tasks text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">运行中任务</h3>
                    <p id="running-task-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <!-- 测试配置区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 设备选择卡片 -->
            <div class="lg:col-span-1 bg-white rounded-lg p-5 card-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fa fa-mobile text-primary mr-2"></i>在线设备
                    </h2>
                    <button id="refresh-device-btn" class="text-primary text-sm flex items-center hover:text-primary/80">
                        <i class="fa fa-refresh mr-1"></i>刷新
                    </button>
                </div>
                <div id="device-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    <!-- 设备列表将通过JS动态渲染 -->
                    <div class="text-center text-light py-8">
                        <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载设备中...</p>
                    </div>
                </div>
            </div>

            <!-- 用例选择与任务控制卡片 -->
            <div class="lg:col-span-2 bg-white rounded-lg p-5 card-shadow">
                <h2 class="text-lg font-semibold flex items-center mb-4">
                    <i class="fa fa-list-alt text-primary mr-2"></i>测试配置
                </h2>

                <!-- 用例选择下拉框 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-light mb-2">选择测试用例</label>
                    <div class="relative">
                        <select id="test-suite-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none cursor-pointer">
                            <option value="" disabled selected>加载用例中...</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-light">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- 任务控制按钮 -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="start-test-btn" class="bg-primary text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" disabled>
                        <i class="fa fa-play mr-2"></i>启动测试
                    </button>
                    <button id="stop-test-btn" class="bg-danger text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-stop mr-2"></i>停止测试
                    </button>
                    <button id="view-report-btn" class="bg-success text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-file-text-o mr-2"></i>查看报告
                    </button>
                </div>

                <!-- 任务状态日志 -->
                <div>
                    <h3 class="text-sm font-medium text-light mb-2">任务状态日志</h3>
                    <div id="task-log" class="w-full h-[200px] border border-gray-200 rounded-lg p-3 overflow-y-auto bg-gray-50 text-sm">
                        <p class="text-light italic">等待测试任务启动...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务历史记录 -->
        <div class="bg-white rounded-lg p-5 card-shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>任务历史记录
                </h2>
                <button id="clear-history-btn" class="text-danger text-sm flex items-center hover:text-danger/80">
                    <i class="fa fa-trash mr-1"></i>清空历史
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-[640px]">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">任务ID</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">设备ID</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">测试用例</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">状态</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">开始时间</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">操作</th>
                        </tr>
                    </thead>
                    <tbody id="task-history-table">
                        <!-- 任务历史将通过JS动态渲染 -->
                        <tr>
                            <td colspan="6" class="text-center py-8 text-light">
                                <i class="fa fa-history text-2xl mb-2"></i>
                                <p>暂无任务历史记录</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-6">
        <div class="container mx-auto px-4 text-center text-light text-sm">
            <p>© 2024 Android UI 自动化测试平台 | 设计与开发：CN-LanBao</p>
        </div>
    </footer>

    <!-- JS 逻辑 -->
    <script>
        // 全局变量
        let currentTaskId = null;          // 当前运行任务ID
        let taskHistory = JSON.parse(localStorage.getItem('taskHistory')) || [];  // 任务历史（本地存储）
        let refreshInterval = null;        // 状态刷新定时器

        // DOM 元素
        const elements = {
            // 概览数据
            onlineDeviceCount: document.getElementById('online-device-count'),
            testSuiteCount: document.getElementById('test-suite-count'),
            runningTaskCount: document.getElementById('running-task-count'),
            currentTime: document.getElementById('current-time'),

            // 设备列表
            deviceList: document.getElementById('device-list'),
            refreshDeviceBtn: document.getElementById('refresh-device-btn'),

            // 测试配置
            testSuiteSelect: document.getElementById('test-suite-select'),
            startTestBtn: document.getElementById('start-test-btn'),
            stopTestBtn: document.getElementById('stop-test-btn'),
            viewReportBtn: document.getElementById('view-report-btn'),
            taskLog: document.getElementById('task-log'),

            // 任务历史
            taskHistoryTable: document.getElementById('task-history-table'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),

            // 刷新按钮
            refreshBtn: document.getElementById('refresh-btn')
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化时间显示
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // 初始化任务历史
            initTaskHistory();

            // 加载设备列表和测试用例
            await Promise.all([
                loadDeviceList(),
                loadTestSuites()
            ]);

            // 绑定事件监听
            bindEventListeners();
        });

        // 事件绑定
        function bindEventListeners() {
            // 刷新按钮
            elements.refreshBtn.addEventListener('click', async () => {
                elements.refreshBtn.querySelector('i').classList.add('fa-spin');
                await Promise.all([
                    loadDeviceList(),
                    loadTestSuites()
                ]);
                elements.refreshBtn.querySelector('i').classList.remove('fa-spin');
            });

            // 设备刷新按钮
            elements.refreshDeviceBtn.addEventListener('click', loadDeviceList);

            // 用例选择变化时更新按钮状态
            elements.testSuiteSelect.addEventListener('change', updateStartBtnStatus);

            // 启动测试
            elements.startTestBtn.addEventListener('click', startTestTask);

            // 停止测试
            elements.stopTestBtn.addEventListener('click', () => {
                addTaskLog('[提示] 任务停止功能暂未实现，需后端接口支持', 'warning');
            });

            // 查看报告
            elements.viewReportBtn.addEventListener('click', () => {
                if (taskHistory.length === 0) {
                    addTaskLog('[错误] 暂无测试报告可查看', 'danger');
                    return;
                }
                const latestTask = taskHistory[0];
                if (latestTask.reportUrl) {
                    window.open(latestTask.reportUrl, '_blank');
                } else {
                    addTaskLog('[错误] 最新任务无报告可查看', 'danger');
                }
            });

            // 清空任务历史
            elements.clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有任务历史记录吗？此操作不可恢复！')) {
                    localStorage.removeItem('taskHistory');
                    taskHistory = [];
                    renderTaskHistory();
                    elements.viewReportBtn.disabled = true;
                    addTaskLog('[提示] 任务历史已清空', 'info');
                }
            });
        }

        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            elements.currentTime.textContent = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 加载设备列表
        async function loadDeviceList() {
            try {
                elements.deviceList.innerHTML = `
                    <div class="text-center text-light py-8">
                        <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载设备中...</p>
                    </div>
                `;

                const response = await fetch('/api/device/list');
                const data = await response.json();

                if (data.code === 200 && Array.isArray(data.data)) {
                    const devices = data.data;
                    elements.onlineDeviceCount.textContent = devices.length;

                    if (devices.length === 0) {
                        elements.deviceList.innerHTML = `
                            <div class="text-center text-light py-8">
                                <i class="fa fa-mobile text-2xl mb-2 opacity-50"></i>
                                <p>未发现在线设备，请检查ADB连接</p>
                            </div>
                        `;
                        elements.startTestBtn.disabled = true;
                        return;
                    }

                    // 渲染设备列表
                    elements.deviceList.innerHTML = devices.map(device => `
                        <div class="border border-gray-200 rounded-lg p-3 hover:border-primary transition-colors cursor-pointer device-item"
                             data-device-id="${device.device_id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium">${device.device_name || device.device_id}</h4>
                                    <p class="text-sm text-light mt-1">
                                        <span>型号：${device.model || '未知'}</span> |
                                        <span>Android ${device.android_version || '未知'}</span>
                                    </p>
                                </div>
                                <span class="bg-success/10 text-success text-xs px-2 py-1 rounded-full">
                                    在线
                                </span>
                            </div>
                        </div>
                    `).join('');

                    // 绑定设备选择事件
                    document.querySelectorAll('.device-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.querySelectorAll('.device-item').forEach(i =>
                                i.classList.remove('border-primary', 'bg-primary/5')
                            );
                            item.classList.add('border-primary', 'bg-primary/5');
                            updateStartBtnStatus();
                        });
                    });

                    // 默认选中第一个设备
                    if (devices.length > 0) {
                        document.querySelector('.device-item').classList.add('border-primary', 'bg-primary/5');
                    }
                } else {
                    throw new Error(data.msg || '加载设备列表失败');
                }
            } catch (error) {
                elements.deviceList.innerHTML = `
                    <div class="text-center text-danger py-8">
                        <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('加载设备列表失败:', error);
            }
        }

        // 加载测试用例
        async function loadTestSuites() {
            try {
                elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>加载用例中...</option>';

                const response = await fetch('/api/test/suites');
                const data = await response.json();

                if (data.code === 200 && Array.isArray(data.data)) {
                    const suites = data.data;
                    elements.testSuiteCount.textContent = suites.length;

                    if (suites.length === 0) {
                        elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>暂无可用测试用例</option>';
                        elements.startTestBtn.disabled = true;
                        return;
                    }

                    // 渲染用例下拉框
                    elements.testSuiteSelect.innerHTML = `
                        <option value="" disabled selected>请选择测试用例</option>
                        ${suites.map(suite => `
                            <option value="${suite.id}" data-abs-path="${suite.abs_path}">
                                ${suite.name} (${suite.rel_path})
                            </option>
                        `).join('')}
                    `;

                    // 更新启动按钮状态
                    updateStartBtnStatus();
                } else {
                    throw new Error(data.msg || '加载测试用例失败');
                }
            } catch (error) {
                elements.testSuiteSelect.innerHTML = `
                    <option value="" disabled selected>加载用例失败</option>
                `;
                elements.startTestBtn.disabled = true;
                addTaskLog(`[错误] 加载测试用例失败: ${error.message}`, 'danger');
                console.error('加载测试用例失败:', error);
            }
        }

        // 更新启动按钮状态
        function updateStartBtnStatus() {
            const selectedDevice = document.querySelector('.device-item.border-primary');
            const selectedSuite = elements.testSuiteSelect.value;
            const isRunning = currentTaskId !== null;

            elements.startTestBtn.disabled = !selectedDevice || !selectedSuite || isRunning;
            elements.viewReportBtn.disabled = taskHistory.length === 0;
        }

        // 添加任务日志
        function addTaskLog(message, type = 'info') {
            const logTypes = {
                info: 'text-dark',
                success: 'text-success',
                warning: 'text-warning',
                danger: 'text-danger'
            };

            const logElement = document.createElement('p');
            logElement.className = `${logTypes[type] || 'text-dark'} mb-1`;
            logElement.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;

            elements.taskLog.appendChild(logElement);
            elements.taskLog.scrollTop = elements.taskLog.scrollHeight;
        }

        // 启动测试任务
        async function startTestTask() {
            try {
                // 获取选中的设备和用例
                const selectedDevice = document.querySelector('.device-item.border-primary');
                const selectedSuiteId = elements.testSuiteSelect.value;

                if (!selectedDevice || !selectedSuiteId) {
                    addTaskLog('[错误] 请先选择设备和测试用例', 'danger');
                    return;
                }

                const deviceId = selectedDevice.dataset.deviceId;
                const suiteName = elements.testSuiteSelect.options[elements.testSuiteSelect.selectedIndex].text;

                // 发送启动测试请求
                addTaskLog(`[信息] 正在启动测试任务（设备：${deviceId}，用例：${suiteName}）`, 'info');

                const response = await fetch('/api/test/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        suite_id: parseInt(selectedSuiteId)
                    })
                });

                const data = await response.json();

                if (data.code === 200 && data.data?.task_id) {
                    currentTaskId = data.data.task_id;
                    addTaskLog(`[成功] 测试任务已启动，任务ID：${currentTaskId}`, 'success');

                    // 更新按钮状态
                    elements.startTestBtn.disabled = true;
                    elements.stopTestBtn.disabled = false;

                    // 开始轮询任务状态
                    startTaskStatusPolling();
                } else {
                    throw new Error(data.msg || '启动测试任务失败');
                }
            } catch (error) {
                addTaskLog(`[错误] 启动测试任务失败: ${error.message}`, 'danger');
                console.error('启动测试任务失败:', error);
            }
        }

        // 轮询任务状态
        function startTaskStatusPolling() {
            // 清除之前的定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            // 开始新的轮询
            const poll = async () => {
                if (!currentTaskId) {
                    clearInterval(refreshInterval);
                    return;
                }

                try {
                    const response = await fetch(`/api/test/status/${currentTaskId}`);
                    const data = await response.json();

                    if (data.code === 200 && data.data) {
                        const task = data.data;

                        // 更新日志
                        if (task.status === 'running') {
                            addTaskLog(`[信息] 任务${currentTaskId}正在执行...`, 'info');
                        } else if (task.status.includes('success') || task.status.includes('failed')) {
                            // 任务已完成
                            addTaskLog(`[信息] 任务${currentTaskId}已${task.status.includes('success') ? '成功' : '失败'}`,
                                task.status.includes('success') ? 'success' : 'danger');

                            // 保存任务到历史记录
                            const suiteInfo = task.suite_info || {};
                            const newTask = {
                                id: currentTaskId,
                                device: task.device_id,
                                suite: suiteInfo.name || '未知用例',
                                status: task.status.includes('success') ? '成功' : '失败',
                                time: task.start_time || new Date().toLocaleString(),
                                reportUrl: task.report_url || ''
                            };
                            taskHistory.unshift(newTask);
                            localStorage.setItem('taskHistory', JSON.stringify(taskHistory));
                            renderTaskHistory();

                            // 停止轮询
                            clearInterval(refreshInterval);
                            currentTaskId = null;

                            // 更新按钮状态
                            elements.stopTestBtn.disabled = true;
                            elements.startTestBtn.disabled = false;
                            elements.viewReportBtn.disabled = false;
                        }
                    } else {
                        throw new Error(data.msg || '获取任务状态失败');
                    }
                } catch (error) {
                    addTaskLog(`[错误] 获取任务状态失败: ${error.message}`, 'danger');
                    console.error('获取任务状态失败:', error);
                }
            };

            // 立即执行一次，然后每3秒执行一次
            poll();
            refreshInterval = setInterval(poll, 3000);
        }

        // 初始化任务历史
        function initTaskHistory() {
            // 确保历史记录结构正确
            taskHistory = taskHistory.map(task => ({
                ...task,
                reportUrl: task.reportUrl || task.report_url || '',
                status: task.status || '未知'
            }));

            renderTaskHistory();
            elements.viewReportBtn.disabled = taskHistory.length === 0;
        }

        // 渲染任务历史
        function renderTaskHistory() {
            if (taskHistory.length === 0) {
                elements.taskHistoryTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-light">
                            <i class="fa fa-history text-2xl mb-2"></i>
                            <p>暂无任务历史记录</p>
                        </td>
                    </tr>
                `;
                return;
            }

            elements.taskHistoryTable.innerHTML = taskHistory.map(task => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${task.id}</td>
                    <td class="py-3 px-4">${task.device}</td>
                    <td class="py-3 px-4">${task.suite}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            task.status === '成功' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'
                        }">
                            ${task.status}
                        </span>
                    </td>
                    <td class="py-3 px-4">${task.time}</td>
                    <td class="py-3 px-4">
                        ${task.reportUrl ? `
                            <button class="text-primary hover:text-primary/80 text-sm"
                                    onclick="window.open('${task.reportUrl}', '_blank')">
                                <i class="fa fa-file-text-o mr-1"></i>查看报告
                            </button>
                        ` : `
                            <span class="text-light text-sm">无报告</span>
                        `}
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>