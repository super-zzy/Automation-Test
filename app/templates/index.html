<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android UI 自动化测试平台</title>
    <!-- 引入 Tailwind CSS（现代CSS框架） -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome（图标库） -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 自定义Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',    // 主色调（蓝色）
                        success: '#00B42A',    // 成功色（绿色）
                        warning: '#FF7D00',    // 警告色（橙色）
                        danger: '#F53F3F',     // 危险色（红色）
                        dark: '#1D2129',       // 深色文本
                        light: '#86909C'       // 浅色文本
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-android text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">Android UI 自动化测试平台</h1>
            </div>
            <div class="flex items hidden flex items-center space-x-4">
                <span id="current-time" class="text-light text-sm"></span>
                <button id="refresh-btn" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full-full transition-colors">
                    <i class="fa fa-refresh text-light"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 状态概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <i class="fa fa-mobile text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">在线设备数</h3>
                    <p id="online-device-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center text-success">
                    <i class="fa fa-list-alt text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">可用测试用例</h3>
                    <p id="test-suite-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                    <i class="fa fa-tasks text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">运行中任务</h3>
                    <p id="running-task-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <!-- 测试配置区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 设备选择卡片 -->
            <div class="lg:col-span-1 bg-white rounded-lg p-5 card-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fa fa-mobile text-primary mr-2"></i>在线设备
                    </h2>
                    <button id="refresh-device-btn" class="text-primary text-sm flex items-center hover:text-primary/80">
                        <i class="fa fa-refresh mr-1"></i>刷新
                    </button>
                </div>
                <div id="device-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    <!-- 设备列表将通过JS动态渲染 -->
                    <div class="text-center text-light py-8">
                        <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载设备中...</p>
                    </div>
                </div>
            </div>

            <!-- 用例选择与任务控制卡片 -->
            <div class="lg:col-span-2 bg-white rounded-lg p-5 card-shadow">
                <h2 class="text-lg font-semibold flex items-center mb-4">
                    <i class="fa fa-list-alt text-primary mr-2"></i>测试配置
                </h2>

                <!-- 用例选择下拉框 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-light mb-2">选择测试用例</label>
                    <div class="relative">
                        <select id="test-suite-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none cursor-pointer">
                            <option value="" disabled selected>加载用例中...</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-light">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- 任务控制按钮 -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="start-test-btn" class="bg-primary text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" disabled>
                        <i class="fa fa-play mr-2"></i>启动测试
                    </button>
                    <button id="stop-test-btn" class="bg-danger text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-stop mr-2"></i>停止测试
                    </button>
                    <button id="view-report-btn" class="bg-success text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-file-text-o mr-2"></i>查看报告
                    </button>
                </div>

                <!-- 任务状态日志 -->
                <div>
                    <h3 class="text-sm font-medium text-light mb-2">任务状态日志</h3>
                    <div id="task-log" class="w-full h-[200px] border border-gray-200 rounded-lg p-3 overflow-y-auto bg-gray-50 text-sm">
                        <p class="text-light italic">等待测试任务启动...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务历史记录 -->
        <div class="bg-white rounded-lg p-5 card-shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>任务历史记录
                </h2>
                <button id="clear-history-btn" class="text-danger text-sm flex items-center hover:text-danger/80">
                    <i class="fa fa-trash mr-1"></i>清空历史
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-[640px]">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">任务ID</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">设备ID</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">测试用例</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">状态</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">开始时间</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">操作</th>
                        </tr>
                    </thead>
                    <tbody id="task-history-table">
                        <!-- 任务历史将通过JS动态渲染 -->
                        <tr>
                            <td colspan="6" class="text-center py-8 text-light">
                                <i class="fa fa-history text-2xl mb-2"></i>
                                <p>暂无任务历史记录</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-light text-sm">
            <p>© 2025 Android UI 自动化测试平台 | 设计与开发：CN-LanBao</p>
        </div>
    </footer>

    <!-- 模态框：任务ID提示 -->
    <div id="task-id-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">测试任务已启动</h3>
                <button id="close-modal-btn" class="text-light hover:text-dark">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-light mb-2">任务ID（用于查询状态）：</p>
                <div class="flex items-center">
                    <input type="text" id="task-id-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-l-lg outline-none text-sm" readonly>
                    <button id="copy-task-id-btn" class="bg-primary text-white px-3 py-2 rounded-r-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-copy"></i>
                    </button>
                </div>
            </div>
            <p class="text-sm text-light mb-4">任务正在后台执行，可在日志区查看实时状态</p>
            <button id="goto-log-btn" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">
                查看任务日志
            </button>
        </div>
    </div>

    <!-- JS 逻辑 -->
    <script>
        // 全局变量
        let currentTaskId = null;          // 当前运行任务ID
        let taskHistory = JSON.parse(localStorage.getItem('taskHistory')) || [];  // 任务历史（本地存储）
        let refreshInterval = null;        // 状态刷新定时器

        // DOM 元素
        const elements = {
            // 概览数据
            onlineDeviceCount: document.getElementById('online-device-count'),
            testSuiteCount: document.getElementById('test-suite-count'),
            runningTaskCount: document.getElementById('running-task-count'),
            currentTime: document.getElementById('current-time'),

            // 设备列表
            deviceList: document.getElementById('device-list'),
            refreshDeviceBtn: document.getElementById('refresh-device-btn'),

            // 测试配置
            testSuiteSelect: document.getElementById('test-suite-select'),
            startTestBtn: document.getElementById('start-test-btn'),
            stopTestBtn: document.getElementById('stop-test-btn'),
            viewReportBtn: document.getElementById('view-report-btn'),
            taskLog: document.getElementById('task-log'),

            // 任务历史
            taskHistoryTable: document.getElementById('task-history-table'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),

            // 模态框
            taskIdModal: document.getElementById('task-id-modal'),
            taskIdInput: document.getElementById('task-id-input'),
            copyTaskIdBtn: document.getElementById('copy-task-id-btn'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            gotoLogBtn: document.getElementById('goto-log-btn'),

            // 其他
            refreshBtn: document.getElementById('refresh-btn')
        };

        // 初始化页面
        window.onload = async function() {
            // 加载时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // 加载设备列表和测试用例
            await Promise.all([
                loadDeviceList(),
                loadTestSuites()
            ]);

            // 加载任务历史
            loadTaskHistory();

            // 检查是否有运行中任务
            checkRunningTasks();

            // 绑定事件
            bindEvents();
        };

        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            elements.currentTime.textContent = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 加载在线设备列表
        async function loadDeviceList() {
            try {
                elements.deviceList.innerHTML = `
                    <div class="text-center text-light py-8">
                        <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载设备中...</p>
                    </div>
                `;

                const response = await fetch('/api/device/list');
                const data = await response.json();

                if (data.code === 200 && Array.isArray(data.data)) {
                    const devices = data.data;
                    elements.onlineDeviceCount.textContent = devices.length;

                    if (devices.length === 0) {
                        elements.deviceList.innerHTML = `
                            <div class="text-center text-light py-8">
                                <i class="fa fa-exclamation-circle text-warning text-2xl mb-2"></i>
                                <p>暂无在线设备</p>
                                <p class="text-xs mt-2">请检查设备ADB连接或USB调试模式</p>
                            </div>
                        `;
                        elements.startTestBtn.disabled = true;
                        return;
                    }

                    // 渲染设备列表（单选）
                    elements.deviceList.innerHTML = devices.map(device => `
                        <div class="device-item border border-gray-200 rounded-lg p-3 cursor-pointer hover:border-primary transition-colors ${device.checked ? 'border-primary bg-primary/5' : ''}"
                             data-device-id="${device.device_id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${device.device_id}</p>
                                    <p class="text-xs text-light mt-1">ATX版本: ${device.atx_version || '未知'}</p>
                                </div>
                                <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center ${device.checked ? 'border-primary bg-primary' : ''}">
                                    ${device.checked ? '<i class="fa fa-check text-white text-xs"></i>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // 绑定设备选择事件
                    document.querySelectorAll('.device-item').forEach(item => {
                        item.addEventListener('click', () => {
                            // 取消其他设备选中状态
                            document.querySelectorAll('.device-item').forEach(el => {
                                el.classList.remove('border-primary', 'bg-primary/5');
                                el.querySelector('.rounded-full').classList.remove('border-primary', 'bg-primary');
                                el.querySelector('.rounded-full').innerHTML = '';
                                el.dataset.checked = 'false';
                            });
                            // 设置当前设备选中状态
                            item.classList.add('border-primary', 'bg-primary/5');
                            item.querySelector('.rounded-full').classList.add('border-primary', 'bg-primary');
                            item.querySelector('.rounded-full').innerHTML = '<i class="fa fa-check text-white text-xs"></i>';
                            item.dataset.checked = 'true';

                            // 更新启动按钮状态
                            updateStartBtnStatus();
                        });
                    });
                } else {
                    throw new Error(data.msg || '加载设备列表失败');
                }
            } catch (error) {
                elements.deviceList.innerHTML = `
                    <div class="text-center text-danger py-8">
                        <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                        <p>加载设备失败：${error.message}</p>
                    </div>
                `;
                console.error('加载设备列表错误:', error);
            }
        }

        // 加载测试用例列表
        async function loadTestSuites() {
            try {
                elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>加载用例中...</option>';

                const response = await fetch('/api/test/suites');
                const data = await response.json();

                if (data.code === 200 && Array.isArray(data.data)) {
                    const suites = data.data;
                    elements.testSuiteCount.textContent = suites.length;

                    if (suites.length === 0) {
                        elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>暂无可用测试用例</option>';
                        elements.startTestBtn.disabled = true;
                        return;
                    }

                    // 渲染用例下拉框
                    elements.testSuiteSelect.innerHTML = `
                        <option value="" disabled selected>请选择测试用例</option>
                        ${suites.map(suite => `
                            <option value="${suite.id}" data-abs-path="${suite.abs_path}">
                                ${suite.name} (${suite.rel_path})
                            </option>
                        `).join('')}
                    `;

                    // 更新启动按钮状态
                    updateStartBtnStatus();
                } else {
                    throw new Error(data.msg || '加载测试用例失败');
                }
            } catch (error) {
                elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>加载用例失败</option>';
                console.error('加载测试用例错误:', error);
                addTaskLog(`[错误] 加载测试用例失败：${error.message}`, 'danger');
            }
        }

        // 更新启动按钮状态
        function updateStartBtnStatus() {
            const selectedDevice = document.querySelector('.device-item[data-checked="true"]');
            const selectedSuite = elements.testSuiteSelect.value;

            // 有选中设备和用例，且无运行中任务时启用
            elements.startTestBtn.disabled = !selectedDevice || !selectedSuite || !!currentTaskId;
        }

        // 启动测试任务
        async function startTestTask() {
            try {
                // 获取选中的设备和用例
                const selectedDevice = document.querySelector('.device-item[data-checked="true"]');
                const selectedSuiteOption = elements.testSuiteSelect.options[elements.testSuiteSelect.selectedIndex];

                if (!selectedDevice || !selectedSuiteOption) {
                    addTaskLog('[错误] 请先选择在线设备和测试用例', 'danger');
                    return;
                }

                const deviceId = selectedDevice.dataset.device_id;
                const suiteId = selectedSuiteOption.value;
                const suiteName = selectedSuiteOption.textContent.split(' (')[0];

                // 禁用按钮，防止重复点击
                elements.startTestBtn.disabled = true;
                elements.testSuiteSelect.disabled = true;
                document.querySelectorAll('.device-item').forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.classList.add('opacity-50');
                });

                addTaskLog(`[信息] 开始启动测试任务：设备=${deviceId}，用例=${suiteName}`, 'info');

                // 调用接口启动任务
                const response = await fetch('/api/test/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        suite_id: parseInt(suiteId)
                    })
                });

                const data = await response.json();

                if (data.code === 200 && data.data?.task_id) {
                    currentTaskId = data.data.task_id;
                    const suiteAbsPath = selectedSuiteOption.dataset.abs_path;

                    // 添加到任务历史（状态为运行中）
                    const task = {
                        taskId: currentTaskId,
                        deviceId: deviceId,
                        suiteName: suiteName,
                        suiteAbsPath: suiteAbsPath,
                        status: 'running',
                        startTime: new Date().toLocaleString('zh-CN'),
                        endTime: null,
                        reportUrl: null
                    };
                    taskHistory.unshift(task);  // 插入到开头
                    saveTaskHistory();
                    loadTaskHistory();

                    // 更新UI状态
                    elements.runningTaskCount.textContent = document.querySelectorAll('.task-status-running').length;
                    elements.stopTestBtn.disabled = false;
                    elements.viewReportBtn.disabled = true;

                    // 显示任务ID模态框
                    elements.taskIdInput.value = currentTaskId;
                    elements.taskIdModal.classList.remove('hidden');

                    // 启动状态刷新定时器（每3秒刷新一次）
                    startTaskStatusRefresh();

                    addTaskLog(`[成功] 测试任务已启动，任务ID：${currentTaskId}`, 'success');
                } else {
                    throw new Error(data.msg || '启动测试任务失败');
                }
            } catch (error) {
                addTaskLog(`[错误] 启动测试任务失败：${error.message}`, 'danger');
                // 恢复按钮状态
                elements.startTestBtn.disabled = false;
                elements.testSuiteSelect.disabled = false;
                document.querySelectorAll('.device-item').forEach(item => {
                    item.style.pointerEvents = 'auto';
                    item.classList.remove('opacity-50');
                });
                console.error('启动测试任务错误:', error);
            }
        }

        // 启动任务状态刷新
        function startTaskStatusRefresh() {
            // 清除之前的定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            // 立即刷新一次
            refreshTaskStatus();

            // 设置定时器（每3秒刷新一次）
            refreshInterval = setInterval(refreshTaskStatus, 3000);
        }

        // 刷新任务状态
        async function refreshTaskStatus() {
            if (!currentTaskId) {
                clearInterval(refreshInterval);
                return;
            }

            try {
                const response = await fetch(`/api/test/status/${currentTaskId}`);
                const data = await response.json();

                if (data.code === 200 && data.data) {
                    const taskStatus = data.data.status;

                    // 更新任务日志
                    if (data.data.pytest_stdout) {
                        // 提取最新日志（避免重复）
                        const newLogs = data.data.pytest_stdout.split('\n').filter(line =>
                            line && !elements.taskLog.textContent.includes(line)
                        );
                        newLogs.forEach(log => addTaskLog(`[测试日志] ${log}`, 'info'));
                    }

                    // 检查任务是否完成
                    if (taskStatus.includes('success') || taskStatus.includes('failed')) {
                        currentTaskId = null;
                        clearInterval(refreshInterval);

                        // 更新任务历史状态
                        const taskIndex = taskHistory.findIndex(task => task.taskId === data.data.task_id);
                        if (taskIndex !== -1) {
                            taskHistory[taskIndex].status = taskStatus.includes('success') ? 'success' : 'failed';
                            taskHistory[taskIndex].endTime = data.data.end_time;
                            taskHistory[taskIndex].reportUrl = data.data.report_url;
                            saveTaskHistory();
                            loadTaskHistory();
                        }

                        // 恢复UI状态
                        elements.stopTestBtn.disabled = true;
                        elements.viewReportBtn.disabled = !data.data.report_url;
                        elements.testSuiteSelect.disabled = false;
                        document.querySelectorAll('.device-item').forEach(item => {
                            item.style.pointerEvents = 'auto';
                            item.classList.remove('opacity-50');
                        });
                        updateStartBtnStatus();

                        // 更新运行中任务数
                        elements.runningTaskCount.textContent = document.querySelectorAll('.task-status-running').length;

                        addTaskLog(`[信息] 测试任务已完成，状态：${taskStatus}`, taskStatus.includes('success') ? 'success' : 'danger');
                        if (data.data.report_url) {
                            addTaskLog(`[信息] 测试报告地址：${data.data.report_url}`, 'success');
                        }
                    }
                }
            } catch (error) {
                addTaskLog(`[错误] 刷新任务状态失败：${error.message}`, 'danger');
                console.error('刷新任务状态错误:', error);
            }
        }

        // 添加任务日志
        function addTaskLog(message, type = 'info') {
            const logElement = document.createElement('p');
            const time = new Date().toLocaleTimeString('zh-CN');

            // 设置日志颜色
            let textColor = 'text-dark';
            if (type === 'success') textColor = 'text-success';
            if (type === 'danger') textColor = 'text-danger';
            if (type === 'warning') textColor = 'text-warning';
            if (type === 'info') textColor = 'text-light';

            logElement.className = `${textColor} mb-1`;
            logElement.innerHTML = `<span class="text-xs text-gray-400">[${time}]</span> ${message}`;

            // 添加到日志容器（滚动到底部）
            elements.taskLog.appendChild(logElement);
            elements.taskLog.scrollTop = elements.taskLog.scrollHeight;
        }

        // 加载任务历史
        function loadTaskHistory() {
            if (taskHistory.length === 0) {
                elements.taskHistoryTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-light">
                            <i class="fa fa-history text-2xl mb-2"></i>
                            <p>暂无任务历史记录</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // 渲染任务历史表格
            elements.taskHistoryTable.innerHTML = taskHistory.map(task => {
                // 状态样式
                let statusClass = 'text-light';
                let statusText = '未知';
                if (task.status === 'running') {
                    statusClass = 'text-warning';
                    statusText = '<span class="flex items-center"><i class="fa fa-spinner fa-spin mr-1"></i>运行中</span>';
                } else if (task.status === 'success' || task.status === 'success_with_failure') {
                    statusClass = 'text-success';
                    statusText = '已完成';
                } else if (task.status.startsWith('failed')) {
                    statusClass = 'text-danger';
                    statusText = '已失败';
                }

                // 报告按钮
                let reportBtn = '<button class="text-light cursor-not-allowed" disabled><i class="fa fa-file-text-o mr-1"></i>无报告</button>';
                if (task.reportUrl) {
                    reportBtn = `<a href="${task.reportUrl}" target="_blank" class="text-primary hover:text-primary/80"><i class="fa fa-file-text-o mr-1"></i>查看报告</a>`;
                }

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors task-row" data-task-id="${task.taskId}">
                        <td class="py-3 px-4 text-sm font-medium ${task.status === 'running' ? 'task-status-running' : ''}">${task.taskId}</td>
                        <td class="py-3 px-4 text-sm">${task.deviceId}</td>
                        <td class="py-3 px-4 text-sm">${task.suiteName}</td>
                        <td class="py-3 px-4 text-sm ${statusClass}">${statusText}</td>
                        <td class="py-3 px-4 text-sm">${task.startTime}</td>
                        <td class="py-3 px-4 text-sm">${reportBtn}</td>
                    </tr>
                `;
            }).join('');

            // 更新运行中任务数
            elements.runningTaskCount.textContent = document.querySelectorAll('.task-status-running').length;
        }

        // 保存任务历史到本地存储
        function saveTaskHistory() {
            // 限制历史记录数量（最多50条）
            if (taskHistory.length > 50) {
                taskHistory = taskHistory.slice(0, 50);
            }
            localStorage.setItem('taskHistory', JSON.stringify(taskHistory));
        }

        // 检查是否有运行中任务
        function checkRunningTasks() {
            const runningTasks = taskHistory.filter(task => task.status === 'running');
            if (runningTasks.length > 0) {
                // 取最新的一个运行中任务
                const latestRunningTask = runningTasks[0];
                currentTaskId = latestRunningTask.taskId;

                // 更新UI状态
                elements.stopTestBtn.disabled = false;
                elements.startTestBtn.disabled = true;
                elements.testSuiteSelect.disabled = true;
                document.querySelectorAll('.device-item').forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.classList.add('opacity-50');
                });

                // 启动状态刷新
                startTaskStatusRefresh();

                addTaskLog(`[信息] 发现未完成任务：${currentTaskId}，正在跟踪状态...`, 'warning');
            }
        }

        // 绑定所有事件
        function bindEvents() {
            // 刷新设备列表
            elements.refreshDeviceBtn.addEventListener('click', loadDeviceList);

            // 全局刷新
            elements.refreshBtn.addEventListener('click', async () => {
                elements.refreshBtn.querySelector('i').classList.add('fa-spin');
                await Promise.all([
                    loadDeviceList(),
                    loadTestSuites()
                ]);
                elements.refreshBtn.querySelector('i').classList.remove('fa-spin');
            });

            // 启动测试
            elements.startTestBtn.addEventListener('click', startTestTask);

            // 停止测试（预留功能，需后端支持）
            elements.stopTestBtn.addEventListener('click', () => {
                addTaskLog('[提示] 任务停止功能暂未实现，需后端接口支持', 'warning');
                // 实际项目中需调用 /api/test/stop 接口
            });

            // 查看报告
            elements.viewReportBtn.addEventListener('click', () => {
                if (taskHistory.length === 0) {
                    addTaskLog('[错误] 暂无测试报告可查看', 'danger');
                    return;
                }
                const latestTask = taskHistory[0];
                if (latestTask.reportUrl) {
                    window.open(latestTask.reportUrl, '_blank');
                } else {
                    addTaskLog('[错误] 最新任务无报告可查看', 'danger');
                }
            });

            // 清空任务历史
            elements.clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有任务历史记录吗？此操作不可恢复！')) {
                    taskHistory = [];
                    saveTaskHistory();
                    loadTaskHistory();
                    addTaskLog('[信息] 任务历史记录已清空', 'info');
                }
            });

            // 模态框：复制任务ID
            elements.copyTaskIdBtn.addEventListener('click', () => {
                elements.taskIdInput.select();
                document.execCommand('copy');
                elements.copyTaskIdBtn.innerHTML = '<i class="fa fa-check"></i> 已复制';
                setTimeout(() => {
                    elements.copyTaskIdBtn.innerHTML = '<i class="fa fa-copy"></i>';
                }, 2000);
            });

            // 模态框：关闭
            elements.closeModalBtn.addEventListener('click', () => {
                elements.taskIdModal.classList.add('hidden');
            });

            // 模态框：查看日志
            elements.gotoLogBtn.addEventListener('click', () => {
                elements.taskIdModal.classList.add('hidden');
                elements.taskLog.scrollTop = elements.taskLog.scrollHeight;
                elements.taskLog.focus();
            });

            // 点击模态框外部关闭
            elements.taskIdModal.addEventListener('click', (e) => {
                if (e.target === elements.taskIdModal) {
                    elements.taskIdModal.classList.add('hidden');
                }
            });

            // 用例选择变化时更新启动按钮状态
            elements.testSuiteSelect.addEventListener('change', updateStartBtnStatus);
        }
    </script>
</body>
</html>
