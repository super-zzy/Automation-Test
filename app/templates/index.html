<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PUTEST - Android UIè‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°</title>
    <style>
        .container { width: 800px; margin: 50px auto; }
        .section { margin: 20px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        select, button { padding: 8px 12px; margin: 0 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button:hover { background: #f5f5f5; }
        #taskStatus { margin-top: 10px; padding: 12px; border-radius: 4px; background: #f5f5f5; min-height: 20px; }
        /* åŠ è½½åŠ¨ç”»æ ·å¼ */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #333; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* çŠ¶æ€é¢œè‰²åŒºåˆ† */
        .status-pending { color: #666; }
        .status-running { color: #007bff; }
        .status-success { color: #28a745; }
        .status-failed { color: #dc3545; }
        #reportSection { margin-top: 15px; display: none; }
        #reportLink { color: #007bff; text-decoration: none; font-weight: bold; }
        #reportLink:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PUTEST - Android UIè‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°</h1>

        <!-- è®¾å¤‡é€‰æ‹© -->
        <div class="section">
            <label>é€‰æ‹©æµ‹è¯•è®¾å¤‡ï¼š</label>
            <select id="deviceSelect"></select>
            <button onclick="loadDevices()">åˆ·æ–°è®¾å¤‡</button>
        </div>

        <!-- ç”¨ä¾‹é€‰æ‹© -->
        <div class="section">
            <label>é€‰æ‹©æµ‹è¯•ç”¨ä¾‹ï¼š</label>
            <select id="suiteSelect"></select>
            <button onclick="loadSuites()">åˆ·æ–°ç”¨ä¾‹</button>
        </div>

        <!-- æµ‹è¯•æ§åˆ¶ -->
        <div class="section">
            <button onclick="startTest()">å¯åŠ¨æµ‹è¯•</button>
            <div id="taskInfo" style="display: none; margin-top: 10px;">
                ä»»åŠ¡IDï¼š<span id="taskId"></span>
                <!-- ç§»é™¤æ‰‹åŠ¨æŸ¥è¯¢æŒ‰é’®ï¼Œæ”¹ä¸ºè‡ªåŠ¨è½®è¯¢ -->
            </div>
        </div>

        <!-- æµ‹è¯•çŠ¶æ€ï¼ˆå«åŠ è½½åŠ¨ç”»ï¼‰ -->
        <div class="section">
            <h3>æµ‹è¯•çŠ¶æ€</h3>
            <div id="taskStatus">è¯·å¯åŠ¨æµ‹è¯•...</div>
        </div>

        <!-- æŠ¥å‘ŠæŸ¥çœ‹ï¼ˆè‡ªåŠ¨æ˜¾ç¤ºï¼‰ -->
        <div class="section" id="reportSection">
            <h3>æµ‹è¯•æŠ¥å‘Š</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šï¼š</p>
            <a id="reportLink" target="_blank">ğŸ“Š æŸ¥çœ‹Allureæµ‹è¯•æŠ¥å‘Š</a>
        </div>
    </div>

    <script>
        let statusPollTimer = null; // å®šæ—¶æŸ¥è¯¢è®¡æ—¶å™¨ï¼ˆå…¨å±€å˜é‡ï¼Œç”¨äºåœæ­¢è½®è¯¢ï¼‰

        // åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰
        function loadDevices() {
            fetch("/api/device/list")
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById("deviceSelect");
                    select.innerHTML = "";
                    if (data.code === 200) {
                        data.data.forEach(dev => {
                            select.innerHTML += `<option value="${dev.device_id}">${dev.device_id}</option>`;
                        });
                    } else {
                        alert(data.msg);
                    }
                });
        }

        // åŠ è½½ç”¨ä¾‹åˆ—è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰
        function loadSuites() {
            fetch("/api/test/suites")
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById("suiteSelect");
                    select.innerHTML = "";
                    if (data.code === 200) {
                        data.data.forEach(suite => {
                            select.innerHTML += `<option value="${suite.id}">${suite.name}ï¼ˆ${suite.rel_path}ï¼‰</option>`;
                        });
                    } else {
                        alert(data.msg);
                    }
                });
        }

        // å¯åŠ¨æµ‹è¯•ï¼ˆæ–°å¢å®šæ—¶è½®è¯¢é€»è¾‘ï¼‰
        function startTest() {
            const deviceId = document.getElementById("deviceSelect").value;
            const suiteId = document.getElementById("suiteSelect").value;
            if (!deviceId || !suiteId) {
                alert("è¯·å…ˆé€‰æ‹©è®¾å¤‡å’Œç”¨ä¾‹");
                return;
            }

            // åœæ­¢ä¹‹å‰å¯èƒ½å­˜åœ¨çš„è½®è¯¢ï¼ˆé¿å…å¤šä¸ªä»»åŠ¡åŒæ—¶è½®è¯¢ï¼‰
            if (statusPollTimer) {
                clearInterval(statusPollTimer);
                statusPollTimer = null;
            }

            fetch("/api/test/start", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ device_id: deviceId, suite_id: parseInt(suiteId) })
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    const taskId = data.data.task_id;
                    document.getElementById("taskId").textContent = taskId;
                    document.getElementById("taskInfo").style.display = "block";
                    // åˆå§‹çŠ¶æ€ï¼šç­‰å¾…æ‰§è¡Œï¼ˆå¸¦åŠ è½½åŠ¨ç”»ï¼‰
                    updateTaskStatusUI("pending", "ç­‰å¾…æ‰§è¡Œ...");
                    // å¯åŠ¨å®šæ—¶è½®è¯¢ï¼ˆæ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡çŠ¶æ€ï¼‰
                    statusPollTimer = setInterval(() => {
                        queryTaskStatus(taskId);
                    }, 2000);
                } else {
                    alert(data.msg);
                }
            });
        }

        // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ–°å¢çŠ¶æ€åˆ¤æ–­ä¸UIæ›´æ–°ï¼‰
        function queryTaskStatus(taskId) {
            fetch(`/api/test/status/${taskId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        const task = data.data;
                        const status = task.status;

                        // 1. æ›´æ–°çŠ¶æ€UIï¼ˆæ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹ï¼‰
                        if (status === "pending") {
                            updateTaskStatusUI("pending", "ç­‰å¾…æ‰§è¡Œ...");
                        } else if (status === "running") {
                            updateTaskStatusUI("running", "æ‰§è¡Œä¸­...");
                        } else if (status.startsWith("success")) {
                            // æµ‹è¯•æˆåŠŸï¼šåœæ­¢è½®è¯¢ï¼Œæ˜¾ç¤ºæŠ¥å‘Šé“¾æ¥
                            clearInterval(statusPollTimer);
                            statusPollTimer = null;
                            updateTaskStatusUI("success", "æµ‹è¯•å®Œæˆï¼");
                            showReportLink(task.report_url); // æ˜¾ç¤ºæŠ¥å‘Šé“¾æ¥
                        } else if (status.startsWith("failed")) {
                            // æµ‹è¯•å¤±è´¥ï¼šåœæ­¢è½®è¯¢ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            clearInterval(statusPollTimer);
                            statusPollTimer = null;
                            updateTaskStatusUI("failed", `æµ‹è¯•å¤±è´¥ï¼š${status.split(":", 2)[1] || "æœªçŸ¥é”™è¯¯"}`);
                        }
                    } else {
                        // æ¥å£é”™è¯¯ï¼šåœæ­¢è½®è¯¢
                        clearInterval(statusPollTimer);
                        statusPollTimer = null;
                        updateTaskStatusUI("failed", `æŸ¥è¯¢å¤±è´¥ï¼š${data.msg}`);
                        alert(data.msg);
                    }
                })
                .catch(error => {
                    // ç½‘ç»œé”™è¯¯ï¼šåœæ­¢è½®è¯¢
                    clearInterval(statusPollTimer);
                    statusPollTimer = null;
                    updateTaskStatusUI("failed", `ç½‘ç»œé”™è¯¯ï¼š${error.message}`);
                });
        }

        // æ›´æ–°çŠ¶æ€UIï¼ˆå°è£…æ ·å¼ä¸å†…å®¹æ›´æ–°ï¼‰
        function updateTaskStatusUI(statusType, content) {
            const statusElem = document.getElementById("taskStatus");
            // æ¸…ç©ºåŸæœ‰å†…å®¹ä¸æ ·å¼
            statusElem.className = "";
            statusElem.innerHTML = "";

            // æ ¹æ®çŠ¶æ€æ·»åŠ æ ·å¼å’Œå†…å®¹ï¼ˆæ‰§è¡Œä¸­æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼‰
            statusElem.classList.add(`status-${statusType}`);
            if (statusType === "running") {
                statusElem.innerHTML = `<span class="loading"></span> ${content}`;
            } else {
                statusElem.textContent = `çŠ¶æ€ï¼š${content}`;
            }
        }

        // æ˜¾ç¤ºæŠ¥å‘Šé“¾æ¥ï¼ˆå°è£…æŠ¥å‘ŠåŒºåŸŸæ˜¾ç¤ºé€»è¾‘ï¼‰
        function showReportLink(reportUrl) {
            const reportSection = document.getElementById("reportSection");
            const reportLink = document.getElementById("reportLink");
            // è®¾ç½®æŠ¥å‘Šé“¾æ¥ï¼ˆç¡®ä¿URLå®Œæ•´ï¼‰
            reportLink.href = reportUrl;
            // æ˜¾ç¤ºæŠ¥å‘ŠåŒºåŸŸ
            reportSection.style.display = "block";
            // å¯é€‰ï¼šè‡ªåŠ¨èšç„¦æŠ¥å‘Šé“¾æ¥ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
            reportLink.focus();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ï¼ˆä¿æŒä¸å˜ï¼‰
        window.onload = () => {
            loadDevices();
            loadSuites();
            // é¡µé¢å…³é—­å‰åœæ­¢è½®è¯¢ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
            window.onbeforeunload = () => {
                if (statusPollTimer) {
                    clearInterval(statusPollTimer);
                }
            };
        };
    </script>
</body>
</html>
