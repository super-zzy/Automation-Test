<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android UI 自动化测试平台</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 自定义Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',    // 主色调（蓝色）
                        success: '#00B42A',    // 成功色（绿色）
                        warning: '#FF7D00',    // 警告色（橙色）
                        danger: '#F53F3F',     // 危险色（红色）
                        dark: '#1D2129',       // 深色文本
                        light: '#86909C'       // 浅色文本
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-android text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">Android UI 自动化测试平台</h1>
            </div>
            <div class="flex items hidden flex items-center space-x-4">
                <span id="current-time" class="text-light text-sm"></span>
                <button id="refresh-btn" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full-full transition-colors">
                    <i class="fa fa-refresh text-light"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 状态概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <i class="fa fa-mobile text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">在线设备数</h3>
                    <p id="online-device-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center text-success">
                    <i class="fa fa-list-alt text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">可用测试用例</h3>
                    <p id="test-suite-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 card-shadow flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center text-warning">
                    <i class="fa fa-tasks text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-light text-sm">运行中任务</h3>
                    <p id="running-task-count" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <!-- 测试配置区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 设备选择卡片 -->
            <div class="lg:col-span-1 bg-white rounded-lg p-5 card-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fa fa-mobile text-primary mr-2"></i>在线设备
                    </h2>
                    <button id="refresh-device-btn" class="text-primary text-sm flex items-center hover:text-primary/80">
                        <i class="fa fa-refresh mr-1"></i>刷新
                    </button>
                </div>
                <div id="device-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    <!-- 设备列表将通过JS动态渲染 -->
                    <div class="text-center text-light py-8">
                        <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载设备中...</p>
                    </div>
                </div>
            </div>

            <!-- 用例选择与任务控制卡片 -->
            <div class="lg:col-span-2 bg-white rounded-lg p-5 card-shadow">
                <h2 class="text-lg font-semibold flex items-center mb-4">
                    <i class="fa fa-list-alt text-primary mr-2"></i>测试配置
                </h2>

                <!-- 用例选择下拉框 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-light mb-2">选择测试用例</label>
                    <div class="relative">
                        <select id="test-suite-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none cursor-pointer">
                            <option value="" disabled selected>加载用例中...</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-light">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <!-- 任务控制按钮 -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="start-test-btn" class="bg-primary text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" disabled>
                        <i class="fa fa-play mr-2"></i>启动测试
                    </button>
                    <button id="stop-test-btn" class="bg-danger text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-stop mr-2"></i>停止测试
                    </button>
                    <button id="view-report-btn" class="bg-success text-white px-6 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-file-text-o mr-2"></i>查看报告
                    </button>
                </div>

                <!-- 用例相关 -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <!-- 编辑用例按钮 -->
                    <button id="edit-suite-btn" class="bg-primary text-white px-4 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-edit mr-2"></i>编辑用例
                    </button>
                    <button id="new-suite-btn" class="bg-success text-white px-4 py-2 rounded-lg flex items-center btn-hover">
                        <i class="fa fa-plus mr-2"></i>新建用例
                    </button>
                    <!-- 添加删除按钮 -->
                    <button id="delete-suite-btn" class="bg-danger text-white px-4 py-2 rounded-lg flex items-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-trash mr-2"></i>删除用例
                    </button>
                </div>

                <!-- 任务状态日志 -->
                <div>
                    <h3 class="text-sm font-medium text-light mb-2">任务状态日志</h3>
                    <div id="task-log" class="w-full h-[200px] border border-gray-200 rounded-lg p-3 overflow-y-auto bg-gray-50 text-sm">
                        <p class="text-light italic">等待测试任务启动...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用例编辑模态框 -->
        <div id="suite-editor-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-bold" id="editor-modal-title">编辑测试用例</h3>
                    <button id="close-editor-btn" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="p-4 flex-grow overflow-hidden flex flex-col">
                    <div class="mb-4" id="new-suite-name-container" class="hidden">
                        <label class="block text-sm font-medium mb-1">用例文件名 (.py)</label>
                        <input type="text" id="new-suite-name" class="w-full px-3 py-2 border rounded" placeholder="例如：my_test.py">
                    </div>
                    <div class="flex-grow overflow-hidden flex flex-col">
                        <textarea id="suite-content" class="flex-grow w-full p-3 border rounded font-mono text-sm" placeholder="请输入测试用例代码..." style="resize: none;"></textarea>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end gap-2">
                    <button id="cancel-edit-btn" class="px-4 py-2 border rounded hover:bg-gray-100">取消</button>
                    <button id="save-suite-btn" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">保存</button>
                </div>
            </div>
        </div>

        <!-- 任务历史记录 -->
        <div class="bg-white rounded-lg p-5 card-shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-history text-primary mr-2"></i>任务历史记录
                </h2>
                <button id="clear-history-btn" class="text-danger text-sm flex items-center hover:text-danger/80">
                    <i class="fa fa-trash mr-1"></i>清空历史
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full min-w-[640px]">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">任务ID</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">设备ID</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">测试用例</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">状态</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">开始时间</th>
                            <th class="text-left py-3 px-4 text-sm font-medium text-light">操作</th>
                        </tr>
                    </thead>
                    <tbody id="task-history-table">
                        <!-- 任务历史将通过JS动态渲染 -->
                        <tr>
                            <td colspan="6" class="text-center py-8 text-light">
                                <i class="fa fa-history text-2xl mb-2"></i>
                                <p>暂无任务历史记录</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-4 mt-6">
        <div class="container mx-auto px-4 text-center text-light text-sm">
            <p>© 2024 Android UI 自动化测试平台 | 设计与开发：CN-LanBao</p>
        </div>
    </footer>

    <!-- JS 逻辑 -->
    <script>
        // 全局变量
        let currentTaskId = null;          // 当前运行任务ID
        let taskHistory = JSON.parse(localStorage.getItem('taskHistory')) || [];  // 任务历史（本地存储）
        let refreshInterval = null;        // 状态刷新定时器

        // DOM 元素
        const elements = {
            // 概览数据
            onlineDeviceCount: document.getElementById('online-device-count'),
            testSuiteCount: document.getElementById('test-suite-count'),
            runningTaskCount: document.getElementById('running-task-count'),
            currentTime: document.getElementById('current-time'),

            // 设备列表
            deviceList: document.getElementById('device-list'),
            refreshDeviceBtn: document.getElementById('refresh-device-btn'),

            // 测试配置
            testSuiteSelect: document.getElementById('test-suite-select'),
            startTestBtn: document.getElementById('start-test-btn'),
            stopTestBtn: document.getElementById('stop-test-btn'),
            viewReportBtn: document.getElementById('view-report-btn'),
            taskLog: document.getElementById('task-log'),

            // 任务历史
            taskHistoryTable: document.getElementById('task-history-table'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),

            // 刷新按钮
            refreshBtn: document.getElementById('refresh-btn')
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化时间显示
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // 初始化任务历史
            initTaskHistory();

            // 加载设备列表和测试用例
            await Promise.all([
                loadDeviceList(),
                loadTestSuites()
            ]);

            // 绑定事件监听
            bindEventListeners();
        });

        // 事件绑定
        function bindEventListeners() {
            // 刷新按钮
            elements.refreshBtn.addEventListener('click', async () => {
                elements.refreshBtn.querySelector('i').classList.add('fa-spin');
                await Promise.all([
                    loadDeviceList(),
                    loadTestSuites()
                ]);
                elements.refreshBtn.querySelector('i').classList.remove('fa-spin');
            });

            // 设备刷新按钮
            elements.refreshDeviceBtn.addEventListener('click', loadDeviceList);

            // 用例选择变化时更新按钮状态
            elements.testSuiteSelect.addEventListener('change', updateStartBtnStatus);

            // 启动测试
            elements.startTestBtn.addEventListener('click', startTestTask);

            // 停止测试
            // 更新stopTestBtn的事件绑定
            elements.stopTestBtn.addEventListener('click', async () => {
                if (!currentTaskId) {
                    addTaskLog('[错误] 没有正在运行的任务', 'danger');
                    return;
                }

                if (confirm(`确定要停止任务 ${currentTaskId} 吗？`)) {
                    try {
                        addTaskLog(`[信息] 正在停止任务 ${currentTaskId}...`, 'info');
                        elements.stopTestBtn.disabled = true;

                        const response = await fetch(`/api/test/stop/${currentTaskId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.code === 200) {
                            addTaskLog(`[成功] 任务 ${currentTaskId} 已停止`, 'success');

                            // 更新任务历史状态
                            const taskIndex = taskHistory.findIndex(task => task.taskId === currentTaskId);
                            if (taskIndex !== -1) {
                                taskHistory[taskIndex].status = 'stopped';
                                taskHistory[taskIndex].endTime = new Date().toLocaleString('zh-CN');
                                saveTaskHistory();
                                loadTaskHistory();
                            }

                            // 恢复UI状态
                            currentTaskId = null;
                            clearInterval(refreshInterval);
                            elements.stopTestBtn.disabled = true;
                            elements.startTestBtn.disabled = false;
                            elements.testSuiteSelect.disabled = false;
                            document.querySelectorAll('.device-item').forEach(item => {
                                item.style.pointerEvents = 'auto';
                                item.classList.remove('opacity-50');
                            });
                            updateStartBtnStatus();
                            elements.runningTaskCount.textContent = document.querySelectorAll('.task-status-running').length;
                        } else {
                            addTaskLog(`[错误] 停止任务失败：${data.msg}`, 'danger');
                            elements.stopTestBtn.disabled = false;
                        }
                    } catch (error) {
                        addTaskLog(`[错误] 停止任务时发生错误：${error.message}`, 'danger');
                        elements.stopTestBtn.disabled = false;
                        console.error('停止任务错误:', error);
                    }
                }
            });

            // 查看报告
            elements.viewReportBtn.addEventListener('click', () => {
                if (taskHistory.length === 0) {
                    addTaskLog('[错误] 暂无测试报告可查看', 'danger');
                    return;
                }
                const latestTask = taskHistory[0];
                if (latestTask.reportUrl) {
                    window.open(latestTask.reportUrl, '_blank');
                } else {
                    addTaskLog('[错误] 最新任务无报告可查看', 'danger');
                }
            });

            // 清空任务历史
            elements.clearHistoryBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有任务历史记录吗？此操作不可恢复！')) {
                    localStorage.removeItem('taskHistory');
                    taskHistory = [];
                    renderTaskHistory();
                    elements.viewReportBtn.disabled = true;
                    addTaskLog('[提示] 任务历史已清空', 'info');
                }
            });
        }

                /**
         * 1. 保存任务历史到 localStorage
         * @param {Array} taskHistory - 任务历史数组（格式见下方说明）
         * 任务对象结构：
         * {
         *   taskId: string,        // 任务唯一ID（如 UUID 或时间戳）
         *   testSuite: string,     // 测试套件名称
         *   deviceId: string,      // 设备ID
         *   deviceName: string,    // 设备名称
         *   status: string,        // 任务状态（running/stopped/completed/failed）
         *   startTime: string,     // 开始时间（格式：YYYY-MM-DD HH:MM:SS）
         *   endTime: string|null,  // 结束时间（未结束为 null）
         *   stopReason: string|null // 停止原因（如用户手动停止/执行失败，未停止为 null）
         * }
         */
        function saveTaskHistory(taskHistory) {
          try {
            // 校验参数：确保是数组，避免存储无效数据
            if (!Array.isArray(taskHistory)) {
              console.error("saveTaskHistory: 任务历史必须是数组");
              return false;
            }

            // 将数组转为 JSON 字符串（localStorage 仅支持字符串存储）
            const taskHistoryStr = JSON.stringify(taskHistory);

            // 存储到 localStorage，键名为 "automation_test_task_history"（避免与其他项目冲突）
            localStorage.setItem("automation_test_task_history", taskHistoryStr);

            console.log(`saveTaskHistory: 成功保存 ${taskHistory.length} 条任务历史`);
            return true;
          } catch (error) {
            console.error("saveTaskHistory: 存储失败", error);
            addTaskLog(`[错误] 任务历史保存失败：${error.message}`, "danger"); // 复用项目已有的日志方法
            return false;
          }
        }

        /**
         * 2. 从 localStorage 加载任务历史
         * @returns {Array} 任务历史数组（若无数据则返回空数组，格式同上）
         */
        function loadTaskHistory() {
          try {
            // 从 localStorage 读取数据
            const taskHistoryStr = localStorage.getItem("automation_test_task_history");

            // 若无数据，返回空数组（避免后续逻辑报错）
            if (!taskHistoryStr) {
              console.log("loadTaskHistory: 未找到任务历史数据，返回空数组");
              return [];
            }

            // 将 JSON 字符串解析为数组
            const taskHistory = JSON.parse(taskHistoryStr);

            // 校验解析结果：确保是数组，避免无效数据影响页面
            if (!Array.isArray(taskHistory)) {
              console.error("loadTaskHistory: 存储的任务历史格式错误，重置为空数组");
              saveTaskHistory([]); // 重置错误数据
              return [];
            }

            console.log(`loadTaskHistory: 成功加载 ${taskHistory.length} 条任务历史`);

            // （可选）加载后更新页面表格显示（需配合项目已有 DOM 结构）
            renderTaskHistoryTable(taskHistory);

            return taskHistory;
          } catch (error) {
            console.error("loadTaskHistory: 加载失败", error);
            addTaskLog(`[错误] 任务历史加载失败：${error.message}`, "danger");
            return [];
          }
        }

        /**
         * （辅助方法）渲染任务历史表格（需配合项目已有 DOM 结构）
         * @param {Array} taskHistory - 任务历史数组
         */
        function renderTaskHistoryTable(taskHistory) {
          const taskHistoryTable = document.getElementById("taskHistoryTable"); // 假设表格 ID 为 taskHistoryTable
          if (!taskHistoryTable) {
            console.error("renderTaskHistoryTable: 未找到任务历史表格 DOM 元素");
            return;
          }

          // 若无任务历史，显示空提示
          if (taskHistory.length === 0) {
            taskHistoryTable.innerHTML = `
              <tr>
                <td colspan="8" class="text-center text-muted">暂无任务历史</td>
              </tr>
            `;
            return;
          }

          // 渲染任务列表（按开始时间倒序，最新任务在最前）
          const taskRows = taskHistory
            .sort((a, b) => new Date(b.startTime) - new Date(a.startTime)) // 时间倒序
            .map((task) => `
              <tr>
                <td>${task.taskId}</td>
                <td>${task.testSuite || "未指定"}</td>
                <td>${task.deviceName || task.deviceId}</td>
                <td>
                  <span class="badge ${
                    task.status === "running" ? "bg-warning" :
                    task.status === "completed" ? "bg-success" :
                    task.status === "stopped" ? "bg-info" : "bg-danger"
                  }">
                    ${task.status === "running" ? "运行中" :
                      task.status === "completed" ? "已完成" :
                      task.status === "stopped" ? "已停止" : "已失败"}
                  </span>
                </td>
                <td>${task.startTime}</td>
                <td>${task.endTime || "未结束"}</td>
                <td>${task.stopReason || "-"}</td>
                <td>
                  <!-- 查看报告按钮 -->
                  <button class="text-primary hover:text-primary/80 view-report-btn" data-task-id="${task.taskId}">
                    <i class="fa fa-file-text-o mr-1"></i>报告
                  </button>
                  <!-- 仅对运行中任务显示停止按钮 -->
                  ${task.status === "running"
                    ? `<button class="text-danger hover:text-danger/80 ml-2 stop-task-btn" data-task-id="${task.taskId}">
                        <i class="fa fa-stop mr-1"></i>停止
                      </button>`
                    : ""}
                </td>
              </tr>
            `)
            .join("");

          // 插入表格内容（假设表格已有表头 <thead>）
          taskHistoryTable.innerHTML = taskRows;

          // 绑定按钮事件（停止任务、查看报告）
          bindTaskHistoryEvents();
        }

        /**
         * （辅助方法）绑定任务历史表格的按钮事件
         */
        function bindTaskHistoryEvents() {
          // 停止任务按钮事件（复用已有的停止任务逻辑）
          document.querySelectorAll(".stop-task-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const taskId = e.currentTarget.dataset.taskId;
              if (!confirm(`确定要停止任务 ${taskId} 吗？`)) return;

              try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>停止中...';

                // 调用后端停止任务接口
                const response = await fetch(`/api/test/stop/${taskId}`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                });
                const data = await response.json();

                if (data.code === 200) {
                  addTaskLog(`[成功] 任务 ${taskId} 已停止`, "success");
                  // 重新加载任务历史，更新表格状态
                  const updatedHistory = loadTaskHistory();
                  // 更新全局任务历史变量（假设项目有全局 taskHistory 变量）
                  window.taskHistory = updatedHistory;
                } else {
                  addTaskLog(`[错误] 停止任务失败：${data.msg}`, "danger");
                }
              } catch (error) {
                addTaskLog(`[错误] 停止任务出错：${error.message}`, "danger");
              } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa fa-stop mr-1"></i>停止';
              }
            });
          });

  // 查看报告按钮事件（根据项目实际报告逻辑扩展）
  document.querySelectorAll(".view-report-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      const taskId = e.currentTarget.dataset.taskId;
      addTaskLog(`[信息] 查看任务 ${taskId} 报告`, "info");
      // 此处可扩展：打开报告弹窗/新页面，加载任务报告数据
      // window.open(`/api/test/report/${taskId}`, "_blank");
    });
  });
}

        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            elements.currentTime.textContent = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 加载设备列表
        async function loadDeviceList() {
            try {
                elements.deviceList.innerHTML = `
                    <div class="text-center text-light py-8">
                        <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>加载设备中...</p>
                    </div>
                `;

                const response = await fetch('/api/device/list');
                const data = await response.json();

                if (data.code === 200 && Array.isArray(data.data)) {
                    const devices = data.data;
                    elements.onlineDeviceCount.textContent = devices.length;

                    if (devices.length === 0) {
                        elements.deviceList.innerHTML = `
                            <div class="text-center text-light py-8">
                                <i class="fa fa-mobile text-2xl mb-2 opacity-50"></i>
                                <p>未发现在线设备，请检查ADB连接</p>
                            </div>
                        `;
                        elements.startTestBtn.disabled = true;
                        return;
                    }

                    // 渲染设备列表
                    elements.deviceList.innerHTML = devices.map(device => `
                        <div class="border border-gray-200 rounded-lg p-3 hover:border-primary transition-colors cursor-pointer device-item"
                             data-device-id="${device.device_id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium">${device.device_name || device.device_id}</h4>
                                    <p class="text-sm text-light mt-1">
                                        <span>型号：${device.model || '未知'}</span> |
                                        <span>Android ${device.android_version || '未知'}</span>
                                    </p>
                                </div>
                                <span class="bg-success/10 text-success text-xs px-2 py-1 rounded-full">
                                    在线
                                </span>
                            </div>
                        </div>
                    `).join('');

                    // 绑定设备选择事件
                    document.querySelectorAll('.device-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.querySelectorAll('.device-item').forEach(i =>
                                i.classList.remove('border-primary', 'bg-primary/5')
                            );
                            item.classList.add('border-primary', 'bg-primary/5');
                            updateStartBtnStatus();
                        });
                    });

                    // 默认选中第一个设备
                    if (devices.length > 0) {
                        document.querySelector('.device-item').classList.add('border-primary', 'bg-primary/5');
                    }
                } else {
                    throw new Error(data.msg || '加载设备列表失败');
                }
            } catch (error) {
                elements.deviceList.innerHTML = `
                    <div class="text-center text-danger py-8">
                        <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('加载设备列表失败:', error);
            }
        }

        // 加载测试用例
        async function loadTestSuites() {
            try {
                elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>加载用例中...</option>';

                const response = await fetch('/api/test/suites');
                const data = await response.json();

                if (data.code === 200 && Array.isArray(data.data)) {
                    const suites = data.data;
                    elements.testSuiteCount.textContent = suites.length;

                    if (suites.length === 0) {
                        elements.testSuiteSelect.innerHTML = '<option value="" disabled selected>暂无可用测试用例</option>';
                        elements.startTestBtn.disabled = true;
                        return;
                    }

                    // 渲染用例下拉框
                    elements.testSuiteSelect.innerHTML = `
                        <option value="" disabled selected>请选择测试用例</option>
                        ${suites.map(suite => `
                            <option value="${suite.id}" data-abs-path="${suite.abs_path}">
                                ${suite.name} (${suite.rel_path})
                            </option>
                        `).join('')}
                    `;

                    // 更新启动按钮状态
                    updateStartBtnStatus();
                } else {
                    throw new Error(data.msg || '加载测试用例失败');
                }
            } catch (error) {
                elements.testSuiteSelect.innerHTML = `
                    <option value="" disabled selected>加载用例失败</option>
                `;
                elements.startTestBtn.disabled = true;
                addTaskLog(`[错误] 加载测试用例失败: ${error.message}`, 'danger');
                console.error('加载测试用例失败:', error);
            }
        }

        // 添加获取所有运行中任务的函数
        async function loadRunningTasks() {
            try {
                const response = await fetch('/api/test/running');
                const data = await response.json();

                if (data.code === 200) {
                    // 更新运行中任务数量显示
                    elements.runningTaskCount.textContent = data.data.length;

                    // 如果当前没有跟踪的任务，但有运行中任务，自动跟踪最新的
                    if (!currentTaskId && data.data.length > 0) {
                        // 按开始时间排序，取最新的任务
                        const sortedTasks = [...data.data].sort((a, b) =>
                            new Date(b.start_time) - new Date(a.start_time)
                        );
                        currentTaskId = sortedTasks[0].task_id;
                        startTaskStatusRefresh();
                        addTaskLog(`[信息] 自动跟踪最新运行中任务：${currentTaskId}`, 'info');
                    }
                }
            } catch (error) {
                console.error('加载运行中任务失败:', error);
            }
        }

        // 修改checkRunningTasks函数
        function checkRunningTasks() {
            // 先从本地历史检查
            const runningTasks = taskHistory.filter(task => task.status === 'running');
            if (runningTasks.length > 0) {
                const latestRunningTask = runningTasks[0];
                currentTaskId = latestRunningTask.taskId;
                updateUIForRunningTask();
                startTaskStatusRefresh();
                addTaskLog(`[信息] 发现未完成任务：${currentTaskId}，正在跟踪状态...`, 'warning');
            } else {
                // 本地没有则从服务器检查
                loadRunningTasks();
            }
        }

        // 添加UI更新辅助函数
        function updateUIForRunningTask() {
            elements.stopTestBtn.disabled = false;
            elements.startTestBtn.disabled = true;
            elements.testSuiteSelect.disabled = true;
            document.querySelectorAll('.device-item').forEach(item => {
                item.style.pointerEvents = 'none';
                item.classList.add('opacity-50');
            });
        }

        // 在全局刷新中添加运行中任务刷新
        elements.refreshBtn.addEventListener('click', async () => {
            elements.refreshBtn.querySelector('i').classList.add('fa-spin');
            await Promise.all([
                loadDeviceList(),
                loadTestSuites(),
                loadRunningTasks()  // 添加这一行
            ]);
            elements.refreshBtn.querySelector('i').classList.remove('fa-spin');
        });

        // 定期刷新运行中任务数量
        setInterval(loadRunningTasks, 10000); // 每10秒刷新一次

        // 更新启动按钮状态
        function updateStartBtnStatus() {
            const selectedDevice = document.querySelector('.device-item.border-primary');
            const selectedSuite = elements.testSuiteSelect.value;
            const isRunning = currentTaskId !== null;

            elements.startTestBtn.disabled = !selectedDevice || !selectedSuite || isRunning;
            elements.viewReportBtn.disabled = taskHistory.length === 0;
        }

        // 添加任务日志
        function addTaskLog(message, type = 'info') {
            const logTypes = {
                info: 'text-dark',
                success: 'text-success',
                warning: 'text-warning',
                danger: 'text-danger'
            };

            const logElement = document.createElement('p');
            logElement.className = `${logTypes[type] || 'text-dark'} mb-1`;
            logElement.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;

            elements.taskLog.appendChild(logElement);
            elements.taskLog.scrollTop = elements.taskLog.scrollHeight;
        }

        // 启动测试任务
        async function startTestTask() {
            try {
                // 获取选中的设备和用例
                const selectedDevice = document.querySelector('.device-item.border-primary');
                const selectedSuiteId = elements.testSuiteSelect.value;

                if (!selectedDevice || !selectedSuiteId) {
                    addTaskLog('[错误] 请先选择设备和测试用例', 'danger');
                    return;
                }

                const deviceId = selectedDevice.dataset.deviceId;
                const suiteName = elements.testSuiteSelect.options[elements.testSuiteSelect.selectedIndex].text;

                // 发送启动测试请求
                addTaskLog(`[信息] 正在启动测试任务（设备：${deviceId}，用例：${suiteName}）`, 'info');

                const response = await fetch('/api/test/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        suite_id: parseInt(selectedSuiteId)
                    })
                });

                const data = await response.json();

                if (data.code === 200 && data.data?.task_id) {
                    currentTaskId = data.data.task_id;
                    addTaskLog(`[成功] 测试任务已启动，任务ID：${currentTaskId}`, 'success');

                    // 更新按钮状态
                    elements.startTestBtn.disabled = true;
                    elements.stopTestBtn.disabled = false;

                    // 开始轮询任务状态
                    startTaskStatusPolling();
                } else {
                    throw new Error(data.msg || '启动测试任务失败');
                }
            } catch (error) {
                addTaskLog(`[错误] 启动测试任务失败: ${error.message}`, 'danger');
                console.error('启动测试任务失败:', error);
            }
        }

        // 轮询任务状态
        function startTaskStatusPolling() {
            // 清除之前的定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            // 开始新的轮询
            const poll = async () => {
                if (!currentTaskId) {
                    clearInterval(refreshInterval);
                    return;
                }

                try {
                    const response = await fetch(`/api/test/status/${currentTaskId}`);
                    const data = await response.json();

                    if (data.code === 200 && data.data) {
                        const task = data.data;

                        // 更新日志
                        if (task.status === 'running') {
                            addTaskLog(`[信息] 任务${currentTaskId}正在执行...`, 'info');
                        } else if (task.status.includes('success') || task.status.includes('failed')) {
                            // 任务已完成
                            addTaskLog(`[信息] 任务${currentTaskId}已${task.status.includes('success') ? '成功' : '失败'}`,
                                task.status.includes('success') ? 'success' : 'danger');

                            // 保存任务到历史记录
                            const suiteInfo = task.suite_info || {};
                            const newTask = {
                                id: currentTaskId,
                                device: task.device_id,
                                suite: suiteInfo.name || '未知用例',
                                status: task.status.includes('success') ? '成功' : '失败',
                                time: task.start_time || new Date().toLocaleString(),
                                reportUrl: task.report_url || ''
                            };
                            taskHistory.unshift(newTask);
                            localStorage.setItem('taskHistory', JSON.stringify(taskHistory));
                            renderTaskHistory();

                            // 停止轮询
                            clearInterval(refreshInterval);
                            currentTaskId = null;

                            // 更新按钮状态
                            elements.stopTestBtn.disabled = true;
                            elements.startTestBtn.disabled = false;
                            elements.viewReportBtn.disabled = false;
                        }
                    } else {
                        throw new Error(data.msg || '获取任务状态失败');
                    }
                } catch (error) {
                    addTaskLog(`[错误] 获取任务状态失败: ${error.message}`, 'danger');
                    console.error('获取任务状态失败:', error);
                }
            };

            // 立即执行一次，然后每3秒执行一次
            poll();
            refreshInterval = setInterval(poll, 3000);
        }

        // 初始化任务历史
        function initTaskHistory() {
            // 确保历史记录结构正确
            taskHistory = taskHistory.map(task => ({
                ...task,
                reportUrl: task.reportUrl || task.report_url || '',
                status: task.status || '未知'
            }));

            renderTaskHistory();
            elements.viewReportBtn.disabled = taskHistory.length === 0;
        }

        // 渲染任务历史
        function renderTaskHistory() {
            if (taskHistory.length === 0) {
                elements.taskHistoryTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-light">
                            <i class="fa fa-history text-2xl mb-2"></i>
                            <p>暂无任务历史记录</p>
                        </td>
                    </tr>
                `;
                return;
            }

            elements.taskHistoryTable.innerHTML = taskHistory.map(task => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${task.id}</td>
                    <td class="py-3 px-4">${task.device}</td>
                    <td class="py-3 px-4">${task.suite}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            task.status === '成功' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'
                        }">
                            ${task.status}
                        </span>
                    </td>
                    <td class="py-3 px-4">${task.time}</td>
                    <td class="py-3 px-4">
                        ${task.reportUrl ? `
                            <button class="text-primary hover:text-primary/80 text-sm"
                                    onclick="window.open('${task.reportUrl}', '_blank')">
                                <i class="fa fa-file-text-o mr-1"></i>查看报告
                            </button>
                        ` : `
                            <span class="text-light text-sm">无报告</span>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        // 元素引用
        elements.editSuiteBtn = document.getElementById('edit-suite-btn');
        elements.newSuiteBtn = document.getElementById('new-suite-btn');
        elements.suiteEditorModal = document.getElementById('suite-editor-modal');
        elements.closeEditorBtn = document.getElementById('close-editor-btn');
        elements.cancelEditBtn = document.getElementById('cancel-edit-btn');
        elements.saveSuiteBtn = document.getElementById('save-suite-btn');
        elements.suiteContent = document.getElementById('suite-content');
        elements.editorModalTitle = document.getElementById('editor-modal-title');
        elements.newSuiteNameContainer = document.getElementById('new-suite-name-container');
        elements.newSuiteName = document.getElementById('new-suite-name');

        // 当前编辑的用例ID
        let currentEditingSuiteId = null;

        // 事件监听
        elements.testSuiteSelect.addEventListener('change', updateEditBtnStatus);
        elements.editSuiteBtn.addEventListener('click', openEditSuiteModal);
        elements.newSuiteBtn.addEventListener('click', openNewSuiteModal);
        elements.closeEditorBtn.addEventListener('click', closeEditorModal);
        elements.cancelEditBtn.addEventListener('click', closeEditorModal);
        elements.saveSuiteBtn.addEventListener('click', saveSuiteContent);

        // 更新编辑按钮状态
        function updateEditBtnStatus() {
            const selectedSuiteValue = elements.testSuiteSelect.value;
            elements.editSuiteBtn.disabled = !selectedSuiteValue;
        }

        // 打开编辑用例模态框
        async function openEditSuiteModal() {
            const selectedSuiteId = elements.testSuiteSelect.value;
            if (!selectedSuiteId) return;

            currentEditingSuiteId = parseInt(selectedSuiteId, 10);
            elements.editorModalTitle.textContent = '编辑测试用例';
            elements.newSuiteNameContainer.classList.add('hidden');

            try {
                const response = await fetch(`/api/test/suite/${currentEditingSuiteId}`);
                const data = await response.json();

                if (data.code === 200 && data.data) {
                    elements.suiteContent.value = data.data.content;
                    elements.suiteEditorModal.classList.remove('hidden');
                } else {
                    throw new Error(data.msg || '获取用例内容失败');
                }
            } catch (error) {
                addTaskLog(`[错误] 打开编辑框失败：${error.message}`, 'danger');
                console.error('打开编辑框错误:', error);
            }
        }

        // 打开新建用例模态框
        function openNewSuiteModal() {
            currentEditingSuiteId = null;
            elements.editorModalTitle.textContent = '新建测试用例';
            elements.newSuiteNameContainer.classList.remove('hidden');
            elements.newSuiteName.value = '';
            elements.suiteContent.value = '# 测试用例\nimport pytest\nimport allure\n\n@allure.feature("新功能测试")\ndef test_demo(d):\n    assert True, "测试通过"';
            elements.suiteEditorModal.classList.remove('hidden');
        }

        // 关闭模态框
        function closeEditorModal() {
            elements.suiteEditorModal.classList.add('hidden');
            currentEditingSuiteId = null;
        }

        // 保存用例内容
        async function saveSuiteContent() {
            try {
                const content = elements.suiteContent.value;

                if (currentEditingSuiteId !== null) {
                    // 更新现有用例
                    const response = await fetch(`/api/test/suite/${currentEditingSuiteId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const data = await response.json();

                    if (data.code === 200) {
                        addTaskLog('[成功] 用例更新成功', 'success');
                        closeEditorModal();
                        loadTestSuites(); // 重新加载用例列表
                    } else {
                        throw new Error(data.msg || '更新用例失败');
                    }
                } else {
                    // 创建新用例
                    const name = elements.newSuiteName.value.trim();
                    if (!name || !name.endsWith('.py')) {
                        addTaskLog('[错误] 文件名必须以.py结尾', 'danger');
                        return;
                    }

                    const response = await fetch('/api/test/suite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, content })
                    });
                    const data = await response.json();

                    if (data.code === 200) {
                        addTaskLog(`[成功] 新用例${name}创建成功`, 'success');
                        closeEditorModal();
                        loadTestSuites(); // 重新加载用例列表
                    } else {
                        throw new Error(data.msg || '创建用例失败');
                    }
                }
            } catch (error) {
                addTaskLog(`[错误] 保存用例失败：${error.message}`, 'danger');
                console.error('保存用例错误:', error);
            }
        }

        // 元素引用
        elements.deleteSuiteBtn = document.getElementById('delete-suite-btn');

        // 事件监听
        elements.deleteSuiteBtn.addEventListener('click', deleteSelectedSuite);

        // 更新编辑和删除按钮状态
        function updateEditBtnStatus() {
            const selectedSuiteValue = elements.testSuiteSelect.value;
            elements.editSuiteBtn.disabled = !selectedSuiteValue;
            elements.deleteSuiteBtn.disabled = !selectedSuiteValue;
        }

        // 删除选中的用例
        async function deleteSelectedSuite() {
            const selectedSuiteId = elements.testSuiteSelect.value;
            const selectedSuiteName = elements.testSuiteSelect.options[elements.testSuiteSelect.selectedIndex].text;

            if (!selectedSuiteId || !confirm(`确定要删除测试用例"${selectedSuiteName}"吗？`)) {
                return;
            }

            try {
                const response = await fetch(`/api/test/suite/${selectedSuiteId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.code === 200) {
                    addTaskLog('[成功] 用例删除成功', 'success');
                    loadTestSuites(); // 重新加载用例列表
                } else {
                    throw new Error(data.msg || '删除用例失败');
                }
            } catch (error) {
                addTaskLog(`[错误] 删除用例失败：${error.message}`, 'danger');
                console.error('删除用例错误:', error);
            }
        }
    </script>
</body>
</html>